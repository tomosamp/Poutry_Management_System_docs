# 月次/年次レポート 機能仕様（設計）

## 関連
- 画面: `docs/03_基本設計/画面設計/管理者/11_月次年次レポート.md`
- 提出フォーマット参考: 個別テンプレート設計書を順次追加する。
- 個別テンプレート:
  - `docs/03_基本設計/機能設計/30_集計・出力/10_ALIC_BR_EXCEL.md`
  - `docs/03_基本設計/機能設計/30_集計・出力/20_ALIC_JG_EXCEL.md`
  - `docs/03_基本設計/機能設計/30_集計・出力/30_ALIC_SC_EXCEL.md`

## 0. 全体概要
### 0.1 提出先と出力形式
- 食鳥新聞：ブロイラーのみ、Excelファイル1件。
- エーリック（農畜産業振興機構）：ブロイラー・成鶏・地鶏をそれぞれExcelで提出し、計3件。
- 畜産日報：ブロイラーをPDFで提出し、計1件。

### 0.2 出力対象と想定ファイル数
| 提出先 | 鳥種 | 形式 | ファイル数 |
| --- | --- | --- | --- |
| エーリック | ブロイラー | Excel | 1 |
| エーリック | 成鶏 | Excel | 1 |
| エーリック | 地鶏 | Excel | 1 |
| 食鳥新聞 | ブロイラー | Excel | 1 |
| 畜産日報 | ブロイラー | PDF | 1 |
| 会員用 | 地鶏 | PDF | 1 |
| 会員用 | 成鶏 | PDF | 1 |

### 0.3 修正メモ
地鶏と成鶏だけ会員さんに別フォーマットのExcelで送付している
- 簡易版のフォーマット形式を別途作成する

#### 合計
- Excel：4件（食鳥新聞1件、エーリック3件）
- PDF：3件（畜産日報1件）
- 総ファイル数：7件

### 0.4 集計粒度の整理
| 提出先 | 主な鳥種 | 地区別集計 | 全国集計 | 備考 |
| --- | --- | --- | --- | --- |
| 食鳥新聞 | ブロイラー | 7地区（北海道・東北〜九州）を別シートで月次表示 | 全国集計シートを併載 | Excel内に地区別・全国の2構成を持つ。(2)の死んじゃった鳥さんの集計も合わせて送っている |
| エーリック | ブロイラー / 成鶏 / 地鶏 | 対応なし | 鳥種ごとに全国月次を作成（年度計含む） | Excelは提出月ごとに列が増加。地鶏は年度開始（5月提出時）から月単位でシートを追加し、最終的に12か月揃う進捗型。 |
| 畜産日報 | ブロイラー  | 地区別構成（ブロイラー、地鶏）をExcel出力→PDF化 | 全国集計を同帳票内で併載 | PDF提出だが元はExcelテンプレート。生鳥処分は内訳（禁止・全部廃棄・一部廃棄）付き。通常のひよこ |
| 会員 | 地鶏 / 成鶏  | 対応なし | 全国集計をPDF | PDF提出だが元はExcelテンプレート。生鳥処分は内訳（禁止・全部廃棄・一部廃棄）付き。通常のひよこ |

### 0.5 Excel出力時の特記事項
- **地鶏（エーリック向け）**：年度開始直後は4月実績のみ。提出月ごとに対象シート（5月版、6月版…）を追加し、列構成が拡張されるためファイル生成時に既存シートへの追記と新シート作成が必要。
- **ブロイラー（食鳥新聞向け）**：地区別×3項目（入雛・処理羽数・処理重量）×12ヶ月＋合計の定型表を複数地区分コピー。地区名称の更新や構成変更がないか年次で確認する。
- **畜産日報PDF**：ExcelテンプレートをPDF化するため、列幅・フォント・注記位置など帳票レイアウトを固定化し、未確定月は “0” or “-” の表現ルールを統一する。
- **共通：月次報告後の修正対応**：`monthly_aggregate_values.aggregate_version_no > 1` の項目は変更差分として背景色を付与する。提出月由来のハイライトと重なる場合は変更差分色（例：薄青 `#B7DEE8`）を優先する。

### 0.6 月次データの格納・鳥種別ルール（ワイドテーブル運用）
- 保存単位: 施設 × 鳥種 × 対象月 × data_kind(actual/plan) ごとに1レコード。登録者は当面 Admin だが ID を保持（将来の生産者入力に備える）。
- 共通カラム: ひな入雛羽数(chick_incoming_count), 生体処理羽数(live_processed_count), 生体処理重量kg(live_processed_weight_kg), 禁止羽数(prohibited_count), 全部廃棄(full_disposal_count), 一部廃棄(partial_disposal_count), コメント(comment_text), 月次メモ(note_text)。
  - `comment_text`: 現行運用では未使用（将来拡張用）。
  - `note_text`: 手入力時の月次メモに加え、CSVコメント（備考）もここに保存する。空欄はNULLを許容。
- 変更履歴: 保存/更新のたびに version_no を上げ、カラム単位の差分を `monthly_record_change_logs` に記録。手入力では項目メモ（change_memo）を残せ、値の変更が無くても「メモのみ」を記録可能。CSVは自動判定で差分を記録。
- エクスポート差分表示: `monthly_aggregate_values.aggregate_version_no > 1` の項目は変更差分色（例：薄青 `#B7DEE8`）で表示し、提出月由来のハイライトより優先する。

#### 0.6.1 単位（入力/内部表現）
- DBの羽数系（`*_count`）は **羽（整数）** で保持する。
  - 画面入力/表示も羽（整数）とし、そのまま羽として保持する。
  - CSV取り込みも羽（整数）を基本とし、そのまま羽として保持する。
- 重量はDBでは **kg（整数）**（`live_processed_weight_kg`）で保持する（入力がトンの場合は `トン × 1000` でkgへ換算）。

#### 0.6.2 ブロイラー
- 実績: 提出月の処理時に「先月」を data_kind=actual で登録（例: 12/15締切時は11月分）。対象項目は ひな入雛羽数 / 生体処理羽数 / 生体処理重量kg / 禁止 / 全部廃棄 / 一部廃棄。
- 予定: 同タイミングで「当月〜+2ヶ月」を data_kind=plan として登録（計3レコード）。対象項目は ひな入雛羽数 / 生体処理羽数 / 生体処理重量kg。

#### 0.6.3 地鶏
- 実績のみ: 「先月」を data_kind=actual で登録。項目は 生体処理羽数 / 生体処理重量kg / 禁止 / 全部廃棄 / 一部廃棄。

#### 0.6.4 成鶏
- 実績のみ: 「先月」を data_kind=actual で登録。項目は 生体処理羽数 / 禁止 / 全部廃棄 / 一部廃棄。
- 生体処理重量は生産者から収集しないため、帳票出力時は `生体処理羽数 × 1.7kg` で算出する（提出フォーマットの備考に従う）。

## DB
- 参照元: `monthly_records`（`docs/04_詳細設計/DB設計/10_monthly_records.md`）
- 集計値: `monthly_aggregate_values`（`docs/04_詳細設計/DB設計/13_monthly_aggregate_values.md`）
- 出力履歴: `agency_exports`（`docs/04_詳細設計/DB設計/12_agency_exports.md`）
- テンプレ: `export_templates`（`docs/04_詳細設計/DB設計/05_export_templates.md`）
- 集計更新: `monthly_records` / `monthly_record_change_logs` 更新時に、鳥種×月×地区/全国の集計値を再計算して保存する。

## 1. 目的
- 提出先テンプレートに合わせたExcel/PDFを生成し、提出用レポートとして出力する。
- 年度内の欠損月は0で出力し、エラーにはしない。

## 2. 入力条件（画面）
- 対象年度（YearPicker）
- 提出月（締切月）
- 提出先フォーマット（`export_templates`）
- グラフ用フィルタ（鳥種/地域ブロック/生産者）※将来利用

## 3. 期間の考え方
- 対象年度はテンプレの鳥種コードで切り替える。
  - ブロイラー（`BR`）: 1月〜12月
  - 地鶏/成鶏（`JG`/`SC`）: 4月〜翌年3月
- 提出月は「実績/予定の対象月」を決定する基準とする。
  - 実績: 提出月の先月
  - 予定: 提出月〜提出月+2（ブロイラーのみ）
- 提出月が年度境界を跨ぐ場合は、当年度/次年度の2ファイルを出力する。

## 4. テンプレ別仕様
- 詳細は個別テンプレートの設計書に従う。
  - `docs/03_基本設計/機能設計/30_集計・出力/10_ALIC_BR_EXCEL.md`
  - `docs/03_基本設計/機能設計/30_集計・出力/20_ALIC_JG_EXCEL.md`
  - `docs/03_基本設計/機能設計/30_集計・出力/30_ALIC_SC_EXCEL.md`
  - 他テンプレは順次追加する。

## 5. 出力処理（概要）
1. テンプレ選択 → 対象年度/提出月の解釈
2. `monthly_aggregate_values` から全国/地区別集計値を取得
   - ALICブロイラーは `data_source=external` の年号行（月次値）も併せて参照
3. 欠損月は0埋め
4. テンプレへ差し込み（値/年号/背景色）
5. 出力（必要に応じて2ファイル）

## 6. 出力履歴（表示）
- 出力日時、テンプレート、提出月、期間、出力形式を表示する。
- 表示対象は直近2年分とする。
