# 生産者詳細・編集 機能仕様

## 1. 概要
- **目的**: 生産者（工場）の各種属性情報を閲覧・更新し、廃業・合併などのステータス管理、特記事項、履歴を扱う。
- **対象画面**: `04_生産者詳細・編集`。
- **前提**: 一覧画面などから `producer_id` を受け取り、Laravelコントローラで該当レコードを取得してBlade描画。

## 2. 主なユースケース
1. 基本情報や所在地を修正し保存する。
2. 代表者・申請者情報を更新し、歴代担当者を履歴として保持する。
3. 廃業登録や合併開始処理を行い、ステータスを切り替える。
4. 特記事項メモを更新し、他画面から参照できるようにする。
5. 個別CSVアップロード／手入力登録の起点として利用する。

## 3. 入出力
| 区分 | 項目 | 内容 |
| --- | --- | --- |
| 入力 | 工場基本情報 | 工場名、カナ、鳥種、事業者種別など。 |
| 入力 | 所在地情報 | 郵便番号、都道府県、市区町村、番地。 |
| 入力 | 代表者情報 | 氏名、役職、電話番号（任意）。 |
| 入力 | 申請者情報 | 氏名、部署、電話、メール、現行フラグ、有効期間。 |
| 入力 | 廃業情報 | 廃業理由、実施日（任意）。 |
| 入力 | 合併情報 | 合併先工場ID、メモ。 |
| 出力 | 編集結果 | 更新成功メッセージ／バリデーションエラー。 |
| 出力 | 履歴 | 最新10件の変更履歴（項目、旧値、新値、更新者、日時）。 |

## 4. ロジック
- **基本情報更新**: `producers` テーブルを更新。郵便番号変更時は住所補完API（将来）を呼び出し、都道府県・市区町村を自動設定。
- **代表者情報**: 任意項目。空の場合はNULL登録。
- **申請者管理**: `producer_applicants` テーブルで履歴管理。無効化時は有効期間の終了日を設定し、行自体は残す。
- **廃業処理**: `producers.retired_at`（タイムスタンプ）と廃業理由を更新し、履歴テーブルにも保存。廃業日時がNULLでなければ一覧では「廃業」と表示。
- **合併処理**: 合併先選択後に統合申請レコードを作成（`producer_merges` テーブル想定）。実行時点ではステータスを「合併申請中」とし、詳細ロジックは別ドキュメントで定義。
- **特記事項メモ**: `producer_notes` テーブル（最新1件）に保存し、更新者・更新日時を保持。API経由で他画面から参照。
- **履歴表示**: `producer_histories` から最新10件を取得し、モーダルで詳細差分を表示。更新履歴はDB上で管理。
- **個別データ取り込み導線**: CSV/手入力ボタン押下時は `producer_id` をクエリに付与して各画面へ遷移。

## 5. バリデーション
- 郵便番号: 7桁数字のみ。ハイフンは入力時に削除。
- 鳥種: ブロイラー／成鶏／地鶏のいずれか。
- 申請者メール: RFC準拠簡易チェック、重複登録禁止。
- 廃業理由: 500文字以内。
- 合併先: 自工場以外の現役工場のみ選択可。廃業済みの工場は対象外。

## 6. 例外・エラー処理
- 更新時に他ユーザーが同時編集した場合は悲観的ロックまたは更新日時チェックで競合検知し、「他のユーザーが更新しました。再読込してから再度保存してください。」を表示。
- 合併処理失敗時は理由をトースト表示し、`storage/logs/laravel.log` にエラー詳細を出力。必要に応じて履歴テーブルにエラー実行記録を残す。
- 廃業・合併の操作は確認ダイアログを表示し、キャンセル可能にする。

## 7. 今後の拡張
- 合併処理の自動データ統合ロジック（提出データ再紐付け、履歴統合）。
