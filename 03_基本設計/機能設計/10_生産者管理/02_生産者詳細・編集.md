# 生産者詳細・編集 機能仕様

## 1. 概要
- **目的**: 生産者（施設）の各種属性情報を閲覧・更新し、廃業・合併などのステータス管理、特記事項メモを扱う。
- **対象画面**: `04_生産者詳細・編集`。
- **前提**: 一覧画面などから `facility_id` を受け取り、Laravelコントローラで該当レコードを取得してBlade描画。

## 2. 主なユースケース
1. 基本情報や所在地を修正し保存する。
2. 代表者・申請者情報を更新し、歴代担当者を履歴として保持する。
3. 廃業登録や合併開始処理を行い、ステータスを切り替える。
4. 特記事項メモを更新し、他画面から参照できるようにする。
5. 手入力登録の起点として利用する。

## 3. 入出力
| 区分 | 項目 | 内容 |
| --- | --- | --- |
| 入力 | 生産者基本情報 | 生産者名、カナ（任意）、鳥種、事業者種別など。 |
| 入力 | 所在地情報 | 都道府県（必須）、郵便番号/市区町村/番地（任意）。 |
| 入力 | 代表者情報 | 氏名、役職、電話番号（任意）。 |
| 入力 | 申請者情報 | 氏名、部署、電話、メール（複数件）。 |
| 入力 | 廃業情報 | 廃業理由、実施日（任意）。 |
| 入力 | 合併情報 | 合併先生産者ID、メモ。 |
| 出力 | 編集結果 | 更新成功メッセージ／バリデーションエラー。 |
| 出力 | - | - | - |

## 4. ロジック
- **基本情報更新**: `facilities` を更新する。
- **代表者/申請者情報**: `producers` を `facility_id` で取得し、`role_type=representative/applicant` で管理する。退任者は `deleted_at` を設定して履歴として残す（物理削除しない）。
- **廃業処理**: `facilities.closed_at` を設定し、必要に応じて `deleted_at` を設定して一覧上は「廃業」として扱う。
- **合併処理**: `facility_merge_histories` に履歴を追加し、合併元施設に `merged_into_facility_id` / `merged_at` を設定する。合併元は参照不可にしたい場合、`deleted_at` を併用する。
- **特記事項メモ**: `producer_notes`（施設メモ）に保存し、更新者・更新日時を保持する。
- **個別データ取り込み導線**: 手入力ボタン押下時は `facility_id` をクエリに付与して各画面へ遷移する。

## 5. バリデーション
- 鳥種: ブロイラー／成鶏／地鶏のいずれか。
- 郵便番号/市区町村/番地/カナ: 任意（入力時は形式・文字数を適用）。
- 申請者メール: RFC準拠簡易チェック、重複登録禁止。
- 廃業理由: 500文字以内。
- 合併先: 自生産者以外の現役生産者のみ選択可。廃業済みの生産者は対象外。

## 6. 例外・エラー処理
- 更新時に他ユーザーが同時編集した場合は悲観的ロックまたは更新日時チェックで競合検知し、「他のユーザーが更新しました。再読込してから再度保存してください。」を表示。
- 合併処理失敗時は理由をトースト表示し、`storage/logs/laravel.log` にエラー詳細を出力。必要に応じて履歴テーブルにエラー実行記録を残す。
- 廃業・合併の操作は確認ダイアログを表示し、キャンセル可能にする。

## 7. 今後の拡張
- 合併処理の自動データ統合ロジック（提出データ再紐付け、履歴統合）。
