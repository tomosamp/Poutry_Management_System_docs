# 生産者新規登録 機能仕様

## 1. 概要
- **目的**: 新規生産者（工場）の基本情報・所在地・申請者情報を登録し、システム内で管理できるようにする。
- **対象画面**: `05_生産者新規登録`。
- **前提**: Laravel + Bladeによるフォーム入力。登録後は生産者詳細画面へ遷移。

## 2. 主なユースケース
1. 新たに加盟した工場の登録を行う。
2. 郵便番号から住所を自動補完し、地域ブロックを半自動で設定する。
3. 申請者を最低1名登録し、データ提出時の窓口を管理する。

## 3. 入出力
| 区分 | 項目 | 内容 |
| --- | --- | --- |
| 入力 | 工場名・工場名カナ | それぞれ100文字以内／任意カナ。重複チェックあり。 |
| 入力 | 鳥種 | ブロイラー／成鶏／地鶏から選択。 |
| 入力 | 事業者種別 | 企業／個人／家族経営。 |
| 入力 | 郵便番号・住所 | 郵便番号7桁。住所フィールド（都道府県、市区町村、番地）。 |
| 入力 | 地域ブロック | 都道府県に基づく自動設定＋手動再選択可。 |
| 入力 | 代表者情報 | 氏名・役職・電話（任意）。 |
| 入力 | 申請者情報 | 氏名（必須）、部署、電話（必須）、メール（必須）。複数登録可。 |
| 入力 | 確認チェック | 「データ内容を確認しました」。 |
| 出力 | 登録結果 | 成功メッセージ／エラーメッセージ。 |

## 4. ロジック
- **重複チェック**: 工場名と組み合わせて重複していないか事前に確認。既存レコードがある場合は詳細画面へのリンクを提示。
- **郵便番号→住所補完**: 郵便番号API（またはローカル辞書）から都道府県・市区町村を自動設定。結果が複数ある場合はユーザーが選択。
- **地域ブロック判定**: 都道府県コードからマスタを参照して初期設定。利用者が上書き可能。
- **申請者登録**: 最低1件必須。フォームで複数行追加し、保存時に `producer_applicants` テーブルへまとめてInsert。
- **登録処理**:
  1. `producers` テーブルに基本情報、所在地、鳥種、事業者種別を登録。
  2. 代表者情報は `producer_representatives` など任意テーブルに保存（任意のためNULL可）。
  3. 申請者情報を登録し、現行フラグを立てる。
  4. 地域ブロックは `producers.block_code` に保持。
- **履歴登録**: 登録完了時に `producer_histories` へ初回登録の履歴を追加し、どの職員がいつ登録したかを残す。
- **遷移**: 登録成功後に詳細画面へリダイレクトし、トーストで成功表示。

## 5. バリデーション
- 工場名: 必須／最大100文字。トリム後にチェック。
- 鳥種・事業者種別: 定義済みコードのみ。
- 郵便番号: 7桁数字。入力時にハイフン除去。
- 市区町村・番地: 各100文字以内。
- 申請者メール: RFC準拠簡易チェック。既存申請者との重複許可（同名でもメールが異なる場合OK）。
- 申請者電話: 数字＋ハイフン15文字以内。
- 確認チェック: ONでない場合は登録不可。

## 6. 例外・エラー処理
- 登録時エラー（DB例外等）はフォーム上部にエラーを表示し、入力値を保持する。詳細は `storage/logs/laravel.log` に出力。
- 郵便番号API失敗時は「住所の自動補完に失敗しました。手動で入力してください。」と表示。
- 重複検知時はエラーとし、既存生産者詳細画面へのリンクを提示。

## 7. 今後の拡張
- CSVインポートによる初期データ投入用スクリプトとの整合。
- 代表者情報の履歴管理。
- 入力途中の一時保存（ドラフト）機能。
