# 提出履歴一覧 機能仕様

## 関連
- 画面: `docs/03_基本設計/画面設計/管理者/09_提出履歴一覧.md`
- 管理ダッシュボード: `docs/03_基本設計/画面設計/管理者/02_管理ダッシュボード.md`
- 生産者一覧: `docs/03_基本設計/画面設計/管理者/03_生産者一覧.md`
- 手入力登録（再提出導線）: `docs/03_基本設計/画面設計/管理者/07_手入力登録.md`

## DB
- 施設: `facilities`（`docs/04_詳細設計/DB設計/06_facilities.md`）
- 参照元: `monthly_records`（`docs/04_詳細設計/DB設計/10_monthly_records.md`）
- 差分ログ: `monthly_record_change_logs`（`docs/04_詳細設計/DB設計/11_monthly_record_change_logs.md`）
- 管理者: `admins`（`docs/04_詳細設計/DB設計/01_admins.md`）

## 1. 目的
- 対象月（実績月）に対して、生産者（施設）ごとの提出状況（未提出/提出済/変更あり）を一覧で把握し、詳細確認・再提出へ素早く遷移できるようにする。

## 2. 用語
- 対象月（実績月）: 本一覧の基準月。DBでは `monthly_records.target_month`（月初日）として保持する。
- 提出月（締切月）: 画面入力（手入力登録等）で選択する月。対象月に対して `対象月 + 1ヶ月` を指す。
- 提出日: `monthly_records.input_timestamp`（CSV）または `monthly_records.created_at`（手入力）を利用し、`COALESCE(input_timestamp, created_at)` を表示する。
- 提出状況:
  - 未提出: 対象月の実績（`data_kind=actual`）が存在しない
  - 提出済: 対象月の実績が存在し、かつ「変更あり」に該当しない
  - 変更あり: 対象月の最新実績で「月次メモあり」または「差分ログあり」

## 3. 対象データ範囲（稼働中の施設）
- 一覧の対象は原則「稼働中の施設」とする。
  - `facilities.deleted_at IS NULL`
  - `facilities.merged_into_facility_id IS NULL`
  - `facilities.closed_at IS NULL OR facilities.closed_at > 今日`

## 4. 入力（クエリ）
- `target_month`（YYYY-MM）
  - 未指定時は運用ルール（提出期限=毎月15日）に従い、当月の対象月を既定値として表示する（`SubmissionPeriod` の `targetMonth`）。
- `q`: 生産者名検索（施設名/施設名カナの部分一致）。
- `bird_species_id`: 鳥種フィルタ。
- `region_block_id`: 地域ブロックフィルタ（成鶏はNULLを許容）。
- `submission_status`: `pending` / `submitted` / `review`（未提出/提出済/変更あり）。
- `input_method`: `csv` / `manual`。
- `sort`: `name` / `submitted_at`（任意）。
- `direction`: `asc` / `desc`（任意）。
- `page`: ページ番号（任意）。
- `sort` 未指定時の既定並び: 鳥種（ブロイラー→地鶏→成鶏）→地域ブロック（A→F）→表示順（sort_order）→生産者名。

## 5. 出力（一覧行）
一覧は「施設1件 = 1行」を基本とし、対象月の最新実績（`data_kind=actual`）を紐付けて表示する。

- 施設情報
  - `facility_id`
  - `facility_name`
  - `bird_species_name`
  - `region_block_display`（例: `A：北海道・東北`、成鶏は `—`）
- 提出状況
  - `submission_status`（`pending`/`submitted`/`review`）
  - `submission_status_label`（未提出/提出済/変更あり）
  - `submission_status_variant`（UIタグ色）
- 提出メタ
  - `submitted_at`（対象月の最新実績の提出日）
  - `input_method`（CSV/手入力）
  - `submitted_by`（担当職員。`registered_by_admin_id` を `admins` へ参照して表示）
- 変更サマリ
  - `has_note`（`note_text` が空白でない）
  - `change_count`（対象月の最新実績に紐づく差分ログ件数）

## 6. 判定ロジック（対象月の最新実績）
1. 対象月（`target_month`）について、施設ごとに `monthly_records`（`data_kind=actual`）の最新レコードを特定する。
   - 同一 `facility_id` / `bird_species_id` / `target_month` のうち `MAX(version_no)` を最新とみなす。
2. 最新実績が存在しない場合、`submission_status='pending'`（未提出）。
3. 最新実績が存在する場合、以下を判定する。
   - `has_note = TRIM(COALESCE(note_text,'')) <> ''`
   - `change_count = COUNT(monthly_record_change_logs WHERE record_id = 最新実績.id)`
   - `requires_review = has_note OR change_count > 0`
   - `requires_review=true` なら `submission_status='review'`（変更あり）、そうでなければ `submission_status='submitted'`（提出済）。

## 7. 遷移
- 提出済/変更あり行: 提出履歴詳細へ遷移（施設ID + 対象月 + 版番号（既定: 最新）を引き渡す）。
- 未提出行: 手入力登録へ遷移（`facility_id` と `submission_month = 対象月 + 1ヶ月` を引き渡す）。

## 8. 備考
- ブロイラーは同一提出月で「実績（対象月）」に加えて「予定（提出月〜+2）」を登録するが、本一覧の提出状況判定は実績（`data_kind=actual`）のみを基準とする。
