# 提出履歴詳細 機能仕様

## 関連
- 画面: `docs/03_基本設計/画面設計/管理者/10_提出履歴詳細.md`
- 提出履歴一覧: `docs/03_基本設計/画面設計/管理者/09_提出履歴一覧.md`
- 手入力登録（再提出）: `docs/03_基本設計/画面設計/管理者/07_手入力登録.md`

## DB
- 施設: `facilities`（`docs/04_詳細設計/DB設計/06_facilities.md`）
- 参照元: `monthly_records`（`docs/04_詳細設計/DB設計/10_monthly_records.md`）
- 変更履歴: `monthly_record_change_logs`（`docs/04_詳細設計/DB設計/11_monthly_record_change_logs.md`）
- 管理者: `admins`（`docs/04_詳細設計/DB設計/01_admins.md`）

## 1. 目的
- 対象月（実績月）の提出内容をスナップショットとして参照し、「変更あり（レビュー対象）」の根拠（メモ/差分）を追えるようにする。
- 再提出（手入力）へ遷移できるようにし、版管理（version_no）による履歴も参照可能にする。

## 2. 画面識別（入力）
本画面は「施設×対象月×実績」を基準に表示する。

- `facility_id`: 施設ID（必須）
- `target_month`: 対象月（YYYY-MM、必須）
- `version_no`: 版番号（任意、未指定時は最新）
- 固定条件: `data_kind=actual`

## 3. 表示内容（出力）
### 3.1 施設情報
- 生産者名（施設名）
- 鳥種
- 地域ブロック（成鶏は `—` を許容）

### 3.2 提出メタ情報（対象月の選択版）
- 対象月（実績月）
- 提出月（締切月）: `対象月 + 1ヶ月`
- 提出日時: `COALESCE(input_timestamp, created_at)`
- 担当職員: `registered_by_admin_id` → `admins`
- 入力経路: `input_method`（CSV/手入力）
- 版番号: `version_no`
- （CSVの場合）送信元メール: `source_email_raw`

### 3.3 提出データ（対象月のスナップショット）
- 鳥種に応じた対象項目を「項目名 / 単位 / 値」で表示する。
  - ブロイラー: `chick_incoming_count`, `live_processed_count`, `live_processed_weight_kg`, `prohibited_count`, `full_disposal_count`, `partial_disposal_count`
  - 地鶏: `live_processed_count`, `live_processed_weight_kg`, `prohibited_count`, `full_disposal_count`, `partial_disposal_count`
  - 成鶏: `live_processed_count`, `prohibited_count`, `full_disposal_count`, `partial_disposal_count`
- 月次メモ（全体メモ）: `note_text`（空欄は `—`）

### 3.4 変更履歴（差分ログ）
- `monthly_record_change_logs` を `record_id=表示中レコード.id` で取得し、`changed_at` の降順で表示する。
- 表示項目: 変更日時、変更者（担当職員）、項目、変更前/変更後、項目メモ（`change_memo`）。

### 3.5 版一覧（版切替）
- 同一 `facility_id` / `bird_species_id` / `target_month` / `data_kind=actual` の `version_no` 一覧を表示し、切替可能とする。
- 版一覧には最低限「版番号」「提出日時」「入力経路」「担当職員」を表示する。

## 4. 未提出（対象月の実績が存在しない場合）
- 画面上は「未提出」として表示し、データ表・差分ログは空表示とする。
- 再提出ボタン（＝新規提出導線）を表示し、手入力登録へ遷移できるようにする。

## 5. 再提出導線（手入力登録）
- 手入力登録へ以下を引き渡して遷移する。
  - `facility_id`
  - `submission_month = 対象月 + 1ヶ月`（YYYY-MM）
- 手入力登録側は最新値を初期表示するため、原則はパラメータ引き渡しのみで「直近データのコピー」を実現する。

## 6. 備考
- 「変更あり（レビュー対象）」の判定は提出履歴一覧と同一（`note_text` または差分ログ件数）とする。
- ブロイラーの予定（`data_kind=plan`）は提出月を基準に複数月が同時に登録されるため、将来的に「提出月単位のセット表示（実績+予定）」を追加する余地がある。
