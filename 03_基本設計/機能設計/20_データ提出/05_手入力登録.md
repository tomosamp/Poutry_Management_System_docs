# 手入力登録 機能仕様

## 関連
- 画面: `docs/03_基本設計/画面設計/管理者/07_手入力登録.md`
- 概要: `docs/03_基本設計/機能設計/00_概要.md`
- 入力確認: `docs/03_基本設計/画面設計/管理者/08_入力確認.md`
- 生産者一覧: `docs/03_基本設計/画面設計/管理者/03_生産者一覧.md`
- 生産者詳細: `docs/03_基本設計/画面設計/管理者/04_生産者詳細・編集.md`

## DB
- 保存先: `monthly_records`（`docs/04_詳細設計/DB設計/10_monthly_records.md`）
- 差分ログ: `monthly_record_change_logs`（`docs/04_詳細設計/DB設計/11_monthly_record_change_logs.md`）

## 1. 目的
- CSV提出が困難な生産者に対し、職員（Admin）が画面上で月次データを直接入力・登録できるようにする。
- 既に入力済み（提出済み）の月も選択可能とし、再登録時は版管理（version_no）と差分ログを残す。

## 2. 用語
- 提出月（画面で選択する月）: YYYY-MM（例: 2026-01）
- 実績月（DBの `target_month`）: 提出月に対して「先月」（例: 提出月=2026-01 → 実績月=2025-12）
- 予定月（DBの `target_month`）: ブロイラーのみ、提出月〜+2ヶ月（計3ヶ月）

## 3. 画面動線
### 3.1 サイドバー起点（生産者未選択）
- サイドバー（データ提出 → 手入力登録）から遷移する。
- 手入力登録画面上部の「生産者指定カード」で生産者を選択してから入力フォームを表示する。

### 3.2 生産者一覧/詳細起点（生産者事前選択）
- 生産者一覧/生産者詳細から、`facility_id` をクエリに付与して手入力登録画面へ遷移する。
- 画面上部の「生産者指定カード」には選択済みの生産者情報を表示し、変更も可能とする（運用上必要ならロック可能）。

### 3.3（参考）提出履歴詳細起点（再提出）
- 提出履歴詳細の「再提出」から、直近データをコピーして手入力登録画面へ遷移する（別紙設計に従う）。

## 4. 提出月の初期値（デフォルト）
- 提出期限が毎月15日のため、提出月の初期値は以下とする。
  - 当日が 1日〜15日: 当月
  - 当日が 16日〜末日: 翌月
- 判定に用いる日付はアプリケーションのタイムゾーン（運用はJST想定）で解釈する。

## 5. 入力対象レコード（鳥種別）
画面で選択した「提出月」を基準として、`monthly_records` に保存する（または既存に対して版上げする）対象は以下。

### 5.1 ブロイラー
- 実績（先月）: `target_month = 提出月 - 1ヶ月`, `data_kind=actual`
  - 入力項目: ひな入雛羽数 / 生体処理羽数 / 生体処理重量kg / 禁止 / 全部廃棄 / 一部廃棄
- 予定（提出月〜+2）: `target_month = 提出月, 提出月+1ヶ月, 提出月+2ヶ月`, `data_kind=plan`（計3レコード）
  - 入力項目: ひな入雛羽数 / 生体処理羽数 / 生体処理重量kg

### 5.2 地鶏
- 実績（先月）: `target_month = 提出月 - 1ヶ月`, `data_kind=actual`
  - 入力項目: 生体処理羽数 / 生体処理重量kg / 禁止 / 全部廃棄 / 一部廃棄

### 5.3 成鶏
- 実績（先月）: `target_month = 提出月 - 1ヶ月`, `data_kind=actual`
  - 入力項目: 生体処理羽数 / 禁止 / 全部廃棄 / 一部廃棄
  - 重量は収集しない（帳票出力時に別途算出）

## 6. 入力値の単位とDB変換
- ひな入雛羽数 / 生体処理羽数
  - 画面/DBともに羽（整数）
- 生体処理重量
  - 画面: kg（整数）
  - DB: kg（整数）として保存
- 生体処分別（禁止/全部廃棄/一部廃棄）
  - 画面/DBともに羽（整数）

## 7. メモ（コメント）仕様
### 7.1 月次メモ（全体メモ）
- 手入力画面に「月次メモ」入力欄を持つ。
- 保存先: `monthly_records.note_text`（手入力では利用する）
- 空欄の場合は `NULL` を保存する。

### 7.2 項目メモ（項目ごとのメモ）
- 手入力では「数値入力欄 + メモ（任意）」をセットで提供する。
- 保存先: `monthly_record_change_logs.change_memo`（手入力で利用する）
- `monthly_records.comment_text` は現行運用では未使用のため、手入力でも利用しない（NULL）。

### 7.3 値変更なしのメモ登録
- 値を変更しなくても、メモだけを残す運用を許容する。
- この場合も差分ログ（`monthly_record_change_logs`）に記録し、`before_value` と `after_value` は同値（文字列化）で保存する。

## 8. 保存・版管理（version_no）
- 手入力の確定登録は「更新」ではなく「版上げ」で行う（既存の最新レコードを残したまま、新しいレコードを追加する）。
- 対象となる各 `target_month`（ブロイラーは実績+予定3ヶ月の計4ヶ月分、地鶏/成鶏は1ヶ月分）について以下を行う。
  1. 既存の最新レコード（同一 `facility_id` / `bird_species_id` / `target_month` / `data_kind`）を取得する。
  2. `version_no = (最新.version_no + 1)` として新規レコードを作成する（既存が無い場合は `version_no=1`）。
  3. `input_method='manual'`, `registered_by_admin_id=ログインAdmin`, `input_timestamp=NULL`, `source_email_raw=NULL`, `comment_text=NULL` とする。
  4. 月次メモ（`note_text`）は保存対象の設計に従って保存する（空欄ならNULL）。

## 9. 差分ログ（monthly_record_change_logs）
- 手入力での確定登録時、以下の条件で差分ログを記録する。
  - 前版から値が変わった項目（数値・メモ含む）
  - 値は変わらないが「項目メモ（change_memo）」を記録したい項目（before=afterで記録）
- `field_name` は `monthly_records` のカラム名を保存する（例: `live_processed_count`）。
- 変更者: `changed_by_type='admin'`, `changed_by_id=ログインAdmin.id`。
