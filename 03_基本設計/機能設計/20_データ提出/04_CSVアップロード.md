# CSVアップロード 機能仕様

## 関連
- 画面: `docs/03_基本設計/画面設計/管理者/06_CSVアップロード.md`
- 取り込み仕様（ブロイラー）: `docs/03_基本設計/機能設計/20_データ提出/01_ブロイラーアップロードフォーマット.md`
- 取り込み仕様（地鶏）: `docs/03_基本設計/機能設計/20_データ提出/02_地鶏アップロードフォーマット.md`
- 取り込み仕様（成鶏）: `docs/03_基本設計/機能設計/20_データ提出/03_成鶏アップロードフォーマット.md`

## DB
- 保存先: `monthly_records`（`docs/04_詳細設計/DB設計/10_monthly_records.md`）
- 差分ログ: `monthly_record_change_logs`（`docs/04_詳細設計/DB設計/11_monthly_record_change_logs.md`）

## 前提（運用）
- CSVは **鳥種別×提出月別×全生産者一括** の1ファイルを取り込む（生産者個別CSVは非対応）。
- 1行目ヘッダー、2行目以降がデータ行。
- ヘッダー文字列は参照せず、**列位置で読み取る**（列数・列順が崩れている場合はエラー）。
- 列数は鳥種別に固定（ブロイラー: 28列 / 地鶏: 17列 / 成鶏: 12列）。成鶏のみ末尾にスコア列が付く場合は13列を許容し、末尾列は無視する。
- スコア列や連絡先列は取り込み対象外（値は保持せず、バリデーション対象外）。

## 処理フロー（概要）
1. 取込画面で鳥種と提出月（YYYY-MM）を選択し、CSVをアップロード。
2. ファイル検証（文字コード/列数/CSV構造）を行い、行単位の正規化・バリデーションを実施。
3. 生産者（施設）を割り出し、`monthly_records` へ登録する候補データを生成。
4. 同画面に検証結果一覧を表示し、問題がなければ「登録する」で確定登録する。

## 生産者（施設）割り出しロジック（確定）
- ブロイラー/地鶏:
  - D〜I（地区列）のうち、最初に値が入っているセルを採用する（複数入力はエラー）。
  - 形式: `^[a-f][0-9]+｜` で開始する（例: `d20｜㈱ウェルファムフーズ 岡山事業所`）。
  - `｜` より前のキー（例: `d20`）を `facility_import_key`（小文字）として抽出する。
  - 照合: 鳥種で `facilities` を絞り、`facilities.import_key` と完全一致で特定する（名称の曖昧一致は行わない）。
- 成鶏:
  - C（企業名）の文字列を「生産者名キー」とする（地区列なし）。
  - `｜` が含まれる場合は右側を採用する（例: `1｜㈱中札内若どり` → `㈱中札内若どり`）。
  - 照合: 鳥種で `facilities` を絞り、以下の正規化後に `facilities.name` と一致で特定する。
    - 前後の空白（全角/半角）除去
    - 連続空白の1個化
    - 先頭の法人格表記は同一視（`㈱` / `株式会社`、`㈲` / `有限会社`）

※ `facilities.import_key` はCSV照合用の施設固有キー（`docs/04_詳細設計/DB設計/06_facilities.md`）であり、同名施設の取り違えリスクを避けるために導入する。

## 対象月の扱い
- 提出月を基準として、登録する `target_month` / `data_kind` を決定する（詳細は各鳥種のアップロードフォーマット仕様に従う）。
