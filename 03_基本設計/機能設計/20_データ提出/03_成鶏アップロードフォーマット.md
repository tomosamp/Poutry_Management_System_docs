# 成鶏アップロードフォーマット機能設計

## 1. 目的
- 成鶏の月次データをCSV（Googleフォーム出力）から取り込み、`monthly_records` へ登録するための取り込み仕様を定義する。

## 2. CSVインポート前提
- 1行目がヘッダー、2行目以降がデータ行。
- **ヘッダー行の文字列は検証しない**（列順固定、列位置で読む）。
- 文字コードはUTF-8（BOM有無どちらでも可）。
- タイムスタンプは `YYYY/MM/DD HH:MM:SS` または `M/D/YYYY H:MM:SS` 形式を許容する。

## 3. ヘッダー定義（列順固定）
※ 実装は列位置で扱い、以下は運用上の確認用。
- A: タイムスタンプ
- B: メールアドレス
- C: 企業名（例: `1｜㈱中札内若どり`）
- D: システムでは利用しない列
- E: 「部署名」  をご記入ください（取り込み対象外）
- F: 「お名前」をご記入ください（取り込み対象外）
- G: 「お電話番号」をご記入ください（取り込み対象外）
- H: 実績数値（単位：羽）
- I: ①禁止 （単位：羽）
- J: ②全部廃棄 （単位：羽）
- K: ③一部廃棄 （単位：羽）
- L: 【コメント】 ご担当者様の変更や何かお気づきの点がございましたらご自由にご記入下さい。

## 4. DBマッピング（主要）
- 登録先: `monthly_records`
- `input_timestamp`: A（タイムスタンプ）
- `source_email_raw`: B（メールアドレス。受領文字列をそのまま保持）
- 対象月の扱い（提出月=取込画面で選択した年月）:
  - 成鶏は実績のみ: 提出月の先月を `data_kind=actual` として登録
- 値カラム:
  - `live_processed_count` ← H（羽、整数）
  - `prohibited_count` / `full_disposal_count` / `partial_disposal_count` ← I/J/K（羽、整数）
  - `note_text` ← L

## 5. 生産者（施設）識別
- C（企業名）を「生産者名キー」として `facilities`（鳥種=成鶏）と照合する（地区列なし）。
  - `｜` が含まれる場合は右側（例: `1｜㈱中札内若どり` → `㈱中札内若どり`）を採用する。
  - 照合は正規化後に一致で特定する（正規化ルールは `docs/03_基本設計/機能設計/20_データ提出/04_CSVアップロード.md` に従う）。

## 6. 単位の扱い
- 羽数系は羽（整数）としてそのまま保持する。
- 成鶏は重量をCSVでは収集しない（帳票出力時に `生体処理羽数 × 1.7kg` を基準に算出）。

## 7. 最低限のバリデーション方針
- 列数が想定（A〜L、12列）と一致しない場合はエラー。
- 数値列は整数以外（空欄/非数値）はNULL扱い（NULL化は警告として集計）。
