# 地鶏アップロードフォーマット機能設計

## 1. 目的
- 地鶏の月次データをCSV（Googleフォーム出力）から取り込み、`monthly_records` へ登録するための取り込み仕様を定義する。

## 2. CSVインポート前提
- 1行目がヘッダー、2行目以降がデータ行。
- **ヘッダー行の文字列は検証しない**（列順固定、列位置で読む）。
- 文字コードはUTF-8（BOM有無どちらでも可）。

## 3. ヘッダー定義（列順固定）
※ 実装は列位置で扱い、以下は運用上の確認用。
- A: タイムスタンプ
- B: メールアドレス
- C: a【北海道・東北地区】
- D: b【関東地区】
- E: c【中部地区】
- F: d【近畿・中国・四国地区】
- G: e【北部九州地区】
- H: f【南部九州地区】
- I: 「お名前」をご記入ください
- J: 「お電話番号」をご記入ください
- K: 生体処理羽数
- L: 生体処理重量
- M: 禁止　（単位：羽）
- N: 全部廃棄　（単位：羽）
- O: 一部廃棄　（単位：羽）
- P: 【コメント】ご担当者様の変更や何かお気づきの点がございましたらご自由にご記入下さい。

## 4. DBマッピング（主要）
- 登録先: `monthly_records`
- `input_timestamp`: A（タイムスタンプ）
- `source_email_raw`: B（メールアドレス。受領文字列をそのまま保持）
- 対象月の扱い（提出月=取込画面で選択した年月）:
  - 地鶏は実績のみ: 提出月の先月を `data_kind=actual` として登録
- 値カラム:
  - `live_processed_count` ← K（羽、整数）
  - `live_processed_weight_kg` ← L（kg、整数）
  - `prohibited_count` / `full_disposal_count` / `partial_disposal_count` ← M/N/O（羽、整数）
  - `comment_text` ← P

## 5. 生産者（施設）識別
- C〜H のうち最初に値が入っているセルを採用し、先頭の地区コード（例: `a3`）と区切り（`｜`）を除去した文字列を「生産者名キー」とする。
  - 例: `c5｜㈱マルセ` → `㈱マルセ`
  - 照合: `facilities` を鳥種（地鶏）で絞り、正規化後に一致で特定する（正規化ルールは `docs/03_基本設計/機能設計/20_データ提出/04_CSVアップロード.md` に従う）。

## 6. 単位の扱い
- 羽数系は羽（整数）としてそのまま保持する。
- 重量はkg（整数）としてそのまま保持する。

## 7. 最低限のバリデーション方針
- 列数が想定（A〜P、16列）と一致しない場合はエラー。
- C〜H の地区列は1列のみ入力されていること（複数入力はエラー）。
- 数値列は整数以外（空欄/非数値）はNULL扱い（重量の小数点以下によるNULL化は警告対象外）。
