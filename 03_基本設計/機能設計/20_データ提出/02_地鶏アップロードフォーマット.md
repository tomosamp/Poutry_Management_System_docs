# 地鶏アップロードフォーマット機能設計

## 1. 目的
- 地鶏の月次データをCSV（Googleフォーム出力）から取り込み、`monthly_records` へ登録するための取り込み仕様を定義する。

## 2. CSVインポート前提
- 1行目がヘッダー、2行目以降がデータ行。
- **ヘッダー行の文字列は検証しない**（列順固定、列位置で読む）。
- 文字コードはUTF-8（BOM有無どちらでも可）。
- タイムスタンプは `YYYY/MM/DD HH:MM:SS` または `M/D/YYYY H:MM:SS` 形式を許容する。

## 3. ヘッダー定義（列順固定）
※ 実装は列位置で扱い、以下は運用上の確認用。
- A: タイムスタンプ
- B: メールアドレス
- C: スコア（Googleフォーム独自。システムでは利用しない）
- D: a【北海道・東北地区】
- E: b【関東地区】
- F: c【中部地区】
- G: d【近畿・中国・四国地区】
- H: e【北部九州地区】
- I: f【南部九州地区】
- J: 「お名前」をご記入ください（取り込み対象外）
- K: 「お電話番号」をご記入ください（取り込み対象外）
- L: 生体処理羽数
- M: 生体処理重量
- N: 禁止　（単位：羽）
- O: 全部廃棄　（単位：羽）
- P: 一部廃棄　（単位：羽）
- Q: 【コメント】ご担当者様の変更や何かお気づきの点がございましたらご自由にご記入下さい。

## 4. DBマッピング（主要）
- 登録先: `monthly_records`
- `input_timestamp`: A（タイムスタンプ）
- `source_email_raw`: B（メールアドレス。受領文字列をそのまま保持）
- 対象月の扱い（提出月=取込画面で選択した年月）:
  - 地鶏は実績のみ: 提出月の先月を `data_kind=actual` として登録
- 値カラム:
  - `live_processed_count` ← L（羽、整数）
  - `live_processed_weight_kg` ← M（kg、整数）
  - `prohibited_count` / `full_disposal_count` / `partial_disposal_count` ← N/O/P（羽、整数）
  - `note_text` ← Q

## 5. 生産者（施設）識別
- D〜I のうち最初に値が入っているセルを採用し、`｜` より前（例: `c5`）を `facility_import_key`（小文字）として抽出する。
  - 例: `c5｜㈱マルセ` → `facility_import_key=c5`
  - 照合: `facilities` を鳥種（地鶏）で絞り、`facilities.import_key` と完全一致で特定する（名称の曖昧一致は行わない）。
  - 施設名（`｜` 以降）は表示・ログ用途のため保持するが、照合には使用しない。

## 6. 単位の扱い
- 羽数系は羽（整数）としてそのまま保持する。
- 重量はkg（整数）としてそのまま保持する。

## 7. 最低限のバリデーション方針
- 列数が想定（A〜Q、17列）と一致しない場合はエラー。
- D〜I の地区列は1列のみ入力されていること（複数入力はエラー）。
- 数値列は整数以外（空欄/非数値）はNULL扱い（重量の小数点以下によるNULL化は警告対象外）。
