# 月次/年次レポート画面（関係機関提出）

## 1. 画面概要
- 目的: 提出先（関係機関/会員向け）を選択し、指定フォーマットで月次/年次レポートをExcel/PDFで出力できるようにする。
- 主利用者: 食鳥協会職員。
- 画面カテゴリ: 集計・出力。

## 2. 主な機能
1. 出力期間の指定（単月/年度）。
2. 提出先フォーマット（テンプレート）選択。
3. 鳥種・地域ブロック・生産者のフィルタ。
4. エクスポート実行（Excel/PDF）。
5. 出力履歴の表示（再出力）。

## 3. 画面要素
| ID | 項目 | 種別 | 内容 | 挙動 |
| --- | --- | --- | --- | --- |
| SEL-REP-01 | 期間タイプ | ラジオボタン | 単月/年度。 | 選択に応じ入力項目切替。 |
| SEL-REP-02 | 期間指定 | 年月/年入力 | 単月: YYYY-MM / 年度(4月〜翌年3月): YYYY。 | 出力条件に反映。 |
| SEL-REP-03 | 提出先フォーマット | セレクト | `export_templates`（提出先テンプレート）を表示。 | 選択で出力レイアウトを切替。 |
| SEL-REP-04 | 鳥種フィルタ | セレクト | 全て/ブロイラー/成鶏/地鶏。 | 絞り込み。 |
| SEL-REP-05 | 地域ブロックフィルタ | セレクト | 全て/A〜F。 | 絞り込み。 |
| FLD-REP-01 | 生産者検索 | テキスト（任意） | 特定生産者のみ出力。 | 部分一致検索。 |
| BTN-REP-01 | Excel出力 | ボタン | 指定条件でExcel生成。 | サーバ側で生成。 |
| BTN-REP-02 | PDF出力 | ボタン | 指定条件でPDF生成。 | サーバ側で生成。 |
| TABLE-REP-01 | 出力履歴 | テーブル | 出力日時、テンプレート、期間、出力形式。 | 履歴行クリックで再出力。 |

## 4. 集計仕様
- 出力元データ: `monthly_records`（対象月/鳥種/施設単位の元データ）を元に、全国/地区×指標（例: 全国・ひな入雛羽数）として整形・集計した値を参照する。
- 成鶏の重量は生産者から収集しないため、提出フォーマットの備考に従い `生体処理羽数 × 1.7kg` で算出する。
- 提出先フォーマット: `export_templates` のレイアウト定義に従い整形する。
- スナップショット: 出力時点の値を `agency_exports` として版管理し、再出力時に過去値との差分セルをハイライトできる設計とする。
  - 単月出力: `agency_exports.period_type='month'` + `target_month=YYYY-MM-01` として1件保存。
  - 年次出力: `agency_exports.period_type='year'` + `target_month=YYYY-04-01`（対象年度の開始月）として1件保存（payloadに12ヶ月分を含める）。

## 5. 備考
- 出力履歴表示期間は2年間（保存はされるが表示は直近2年分）。
- 将来の生産者向けポータルに転用できるよう、出力条件・テンプレート選択はAPI化を前提にする。
