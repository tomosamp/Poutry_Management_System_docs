# 月次/年次レポート画面（関係機関提出）

## 1. 画面概要
- 目的: 提出先（関係機関/会員向け）を選択し、指定フォーマットで月次/年次レポートをExcel/PDFで出力できるようにする。
- 主利用者: 食鳥協会職員。
- 画面カテゴリ: 集計・出力。

## 2. 主な機能
1. 対象年度/提出月の指定。
2. 提出先フォーマット（テンプレート）選択。
3. グラフ用フィルタ（鳥種/地域ブロック/生産者）※将来利用。
4. エクスポート実行（Excel/PDF）。
5. 出力履歴の表示（再出力）。

## 3. 画面要素
| ID | 項目 | 種別 | 内容 | 挙動 |
| --- | --- | --- | --- | --- |
| SEL-REP-01 | 対象年度 | 年度ピッカー | `YYYY`。 | テンプレの鳥種コードにより 1-12 / 4-3 の年度区分を表示。 |
| SEL-REP-02 | 提出月（締切月） | 月ピッカー | `YYYY-MM`。 | 実績=提出月-1、予定=提出月〜+2（ブロイラーのみ）。 |
| SEL-REP-03 | 提出先フォーマット | セレクト | `export_templates`（提出先テンプレート）を表示。 | 選択で出力レイアウトを切替。 |
| SEL-REP-04 | 鳥種フィルタ | セレクト | 全て/ブロイラー/成鶏/地鶏。 | グラフ用（将来利用）。 |
| SEL-REP-05 | 地域ブロックフィルタ | セレクト | 全て/A〜F。 | グラフ用（将来利用）。 |
| SEL-REP-06 | 生産者フィルタ | セレクト | 鳥種×地域ブロック連動。 | グラフ用（将来利用）。 |
| BTN-REP-01 | Excel出力 | ボタン | 指定条件でExcel生成。 | サーバ側で生成。 |
| BTN-REP-02 | PDF出力 | ボタン | 指定条件でPDF生成。 | サーバ側で生成。 |
| TABLE-REP-01 | 出力履歴 | テーブル | 出力日時、テンプレート、提出月、期間、出力形式。 | 履歴行クリックで再出力。 |

## 4. 集計仕様
- 出力元データ: `monthly_records` を集計し、`monthly_aggregate_values` として保存した値を参照する。
- `monthly_records` / `monthly_record_change_logs` 更新時に、鳥種×月×地区/全国の集計値を再計算する。
- 年度区分はテンプレの鳥種コードで切り替える（ブロイラー=1-12、地鶏/成鶏=4-3）。
- 提出月の先月を実績、提出月〜+2を予定（ブロイラーのみ）として扱う。
- 欠損月は0で出力し、エラーにしない。
- 提出先フォーマット: `export_templates` のレイアウト定義に従い整形する。
- スナップショット: 出力時点の値を `agency_exports` として版管理し、再出力時に過去値との差分セルをハイライトできる設計とする。
  - 年次出力: `agency_exports.period_type='year'` + `target_month` は対象年度の開始月を保持。

## 5. 備考
- 出力履歴表示期間は2年間（保存はされるが表示は直近2年分）。
- 将来の生産者向けポータルに転用できるよう、出力条件・テンプレート選択はAPI化を前提にする。
