# CSVアップロード画面

## 1. 画面概要
- 目的: 鳥種別×提出月別の月次データ（全生産者分）をCSVから取り込み、形式・項目・数値の妥当性検証を実施した上で登録に進む。
- 主利用者: 食鳥協会職員。
- 画面カテゴリ: データ提出。

## 2. 主なフロー
1. 画面上部の「一括アップロード」ボタンからモーダルを開く（ヘッダー常設）。
2. 鳥種を選択（ブロイラー/地鶏/成鶏）。
3. 提出月（YYYY-MM）を選択（初期値は当月、または運用で定めた既定値）。
4. ドラッグ&ドロップ領域にCSVファイルを投入（1ファイル）。
5. アップロード直後に自動検証を実行し、行ごとのステータス結果（OK/警告/エラー）をテーブル表示。
6. 入力確認画面に引き渡し、全生産者分を一覧（foreach表示）で最終確認・修正して確定登録する。

## 3. 画面要素
| ID | 項目 | 種別 | 必須 | 検証・挙動 |
| --- | --- | --- | --- | --- |
| BTN-UP-HEAD-01 | 一括アップロード | ボタン | - | 画面ヘッダーに固定表示。押下でモーダルを開き、対象月/ファイルの設定を誘導。 |
| SEL-UP-01 | 鳥種 | セレクト | 必須 | ブロイラー/地鶏/成鶏。選択に応じて想定列数・列位置マッピングを切替。 |
| SEL-UP-02 | 提出月 | 月選択 | 必須 | YYYY-MM形式。提出月を基準に「登録対象月（先月実績など）」を決定する。 |
| DROP-UP-01 | CSVドラッグ&ドロップエリア | ドロップゾーン | 必須 | 1ファイル。 |
| FLD-UP-01 | CSVファイル | ファイル選択 | 任意 | ドロップが難しい場合のフォールバック。 |
| BTN-UP-01 | アップロード開始 | ボタン | - | ファイル投入後に活性化、即時検証を実行。 |
| TABLE-UP-01 | 検証結果一覧 | テーブル | - | 行単位で生産者名/項目/ステータス（OK/警告/エラー）を表示。 |
| BTN-UP-02 | 確認へ進む | ボタン | - | 入力確認画面へ進む（エラー/警告はそのまま引き継ぎ、確認画面で修正可能）。 |
| BTN-UP-04 | キャンセル | ボタン | - | 生産者一覧またはデータ提出メニューへ戻る。 |

## 4. 検証ルール
- ファイル形式: 列数チェック（鳥種別に固定）。ヘッダー文字列は検証せず、列位置で読み取る。
  - 列数: ブロイラー 28列 / 地鶏 17列 / 成鶏 12列。
  - スコア列・連絡先列（部署名/氏名/電話番号）は取り込み対象外。
- 項目検証: ブロイラー/地鶏/成鶏で入力項目が異なるため、画面で選択した鳥種に応じて検証テンプレートを選択。
- 数値範囲: 負値禁止、桁数チェック。Null（空欄）は許容し、意図的な未入力をエラー判定しない。
- 比較検証: 導入羽数 < 処理羽数の場合は警告、前年度同月比±30%を超える際に警告。
- 生産者（施設）の割り出しは鳥種別CSVの識別列（地区列/企業名など）から行う。
  - ブロイラー/地鶏: 地区列セルの先頭キー（例: `d20｜...` の `d20`）を `facilities.import_key` と照合し、完全一致で特定する。
  - 成鶏: 企業名列が `1｜㈱中札内若どり` のような場合は `｜` の右側を採用し、正規化して `facilities.name` と照合する。
  - 未割り当て行（照合できない/複数候補になる）はエラーとする。

## 5. メッセージ仕様
- エラー: 「生産者（施設）: XXX の翌月予定が未入力です」など具体的項目名と対象行を表示。
- 警告: 黄色アイコン表示、続行可能。
- 成功: 「検証が完了しました。確認画面へ進んでください。」

## 6. 遷移
- 確認へ進む → 入力確認画面（検証結果を保持して遷移）。
- キャンセル → 生産者一覧（選択状態は破棄）。

## 7. 備考
- Googleフォーム経由で取得したCSVを想定し、標準フォーマット（提出月×鳥種ごとに、生産者ごとの行が並ぶ）を前提とする。
- 生産者個別CSVアップロードは対応しない（鳥種別×提出月別の一括専用）。
- アップロードにより生成されたレコードは生産者に紐付いて履歴登録され、既存データとの差分は保持する。差分統合ロジックは次フェーズで詳細設計。
- CSV項目ごとの補足メモ（備考列）を保持し、手入力画面と共通のメモAPIで参照可能にする。
- エラーが残る行は入力確認画面に渡し確認、必要があればその場での修正。
