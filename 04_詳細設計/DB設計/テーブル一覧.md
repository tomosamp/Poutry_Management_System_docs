# DBテーブル一覧（暫定案）

- 対象ドキュメント: `docs/03_基本設計` 配下の画面設計・機能設計。
- 目的: 主要ユースケースを実現するためのテーブル候補を洗い出し、詳細設計前に粒度・責務をすり合わせる。
- ステータス: 2025-11-20 時点のドラフト。列構成や正規化方針は今後の議論で調整する。

## 記法
- `PK`/`FK` は主キー・外部キーを指す。
- 型は概略。実際の桁数・制約はER設計フェーズで確定する。
- `根拠` には参照した設計ドキュメントを記載（複数可）。

---

## 1. 認証・共通運用

### 1.1 `admins`（必須）
- 用途: 共通管理者アカウント。将来の職員単位認証にも拡張可能な構造とする。
- 主キー: `id`。
- 主なカラム: `login_id`(unique), `password_hash`, `display_name`, `is_locked`, `last_login_at`。
- リレーション: `admin_audit_logs`, `submissions.submitted_by_admin_id`, `producer_histories.performed_by_admin_id` などで参照。
- 根拠: ログイン要件（画面設計/01_ログイン, 機能設計/01_認証/共通管理者認証）。

### 1.2 `admin_audit_logs`（推奨）
- 用途: ログイン/ログアウト/設定変更等の証跡。IP, User-Agent, 成否を保存。
- 主キー: `id`。
- 主なカラム: `admin_id`(FK), `action`, `result`, `ip_address`, `logged_at`, `payload_json`。
- 根拠: 認証仕様の監査ログ要件（機能設計/01_認証）。

### 1.3 `system_settings`（必須）
- 用途: システム全体の可変設定（提出締切日、CSV最大行数、警告閾値の初期値等）。
- 主キー: `key`。
- 主なカラム: `value`, `value_type`, `description`, `updated_by_admin_id`。
- 根拠: ダッシュボード締切表示（画面設計/02_管理ダッシュボード）、CSV制限（機能設計/20_データ提出/01_ブロイラー）。

---

## 2. マスタ系

### 2.1 `bird_species`（必須）
- 用途: 鳥種マスタ。`code`（BR/SC/JGなど）で表記統一。
- 主なカラム: `code`, `name`, `display_order`, `is_active`。
- 根拠: 画面共通で使用（画面設計/03_生産者一覧, 07_手入力登録 等）。

### 2.2 `region_blocks`（必須）
- 用途: A〜F地区ブロックの定義と表示順。
- 主なカラム: `code`, `name`, `description`, `sort_order`。
- 根拠: 生産者登録時の地域ブロック自動設定（画面設計/05_生産者新規登録）。

### 2.3 `prefectures`（必須）
- 用途: 都道府県マスタ。`region_block_code` を保持し、郵便番号補完処理に利用。
- 主なカラム: `code`, `name`, `region_block_code`, `is_active`。
- 根拠: 住所自動補完＆ブロック紐付け（画面設計/05_生産者新規登録, 04_生産者詳細）。

### 2.4 `postal_code_mappings`（要検討）
- 用途: 郵便番号→都道府県/市区町村変換。日本郵便データ等をロード。
- 主なカラム: `postal_code`, `prefecture_code`, `city`, `town`, `last_synced_at`。
- 根拠: 郵便番号から住所自動補完（画面設計/05_生産者新規登録, 04_生産者詳細）。外部API利用の場合はキャッシュ用途。

### 2.5 `operator_types`（必須）
- 用途: 事業者種別（企業/個人/家族経営）のマスタ。
- 主なカラム: `code`, `name`, `display_order`, `is_active`。
- 根拠: 生産者登録入力項目（画面設計/05）。

### 2.6 `submission_metric_definitions`（必須）
- 用途: 鳥種別に必要な入力項目を定義（例: ブロイラーの10月実績羽数、処理重量、廃棄内訳等）。
- 主なカラム: `metric_code`, `bird_species_code`, `label`, `unit`, `value_type`(int/decimal), `month_offset`, `required_flag`, `order_in_form`。
- 利用: 検証/入力フォーム/エクスポートで共通利用。`submission_values` や `submission_staging_values` が参照。
- 根拠: CSV項目一覧・手入力項目（画面設計/07, 機能設計/20_データ提出/01_ブロイラー）。

### 2.7 `warning_rules`（推奨）
- 用途: 平均重量や前年比チェックなどの警告閾値を管理。
- 主なカラム: `rule_code`, `bird_species_code`, `metric_code`, `comparison_type`, `threshold_low`, `threshold_high`, `severity`, `message_template`, `is_active`。
- 根拠: 入力確認での平均重量チェック、導入羽数 < 処理羽数警告、前年比±30%警告（画面設計/07, 08; 機能設計/20_データ提出/01_ブロイラー）。

### 2.8 `export_templates`（必須）
- 用途: 食鳥新聞/エーリック/畜産日報など提出先別のテンプレート設定。
- 主なカラム: `code`, `name`, `output_format`(CSV/PDF), `description`, `bird_species_code`, `layout_definition`(JSON), `is_active`。
- 根拠: 集計・エクスポート要件（画面設計/11,12; 機能設計/30_集計・出力/00概要, 01ブロイラー提出フォーマット）。

### 2.9 `export_template_columns`（推奨）
- 用途: テンプレート毎にどの `submission_metric_definitions` を参照するかマッピング。
- 主なカラム: `template_code`, `metric_code`, `column_order`, `aggregation_type`(sum/avg/last)。
- 根拠: 地区別/全国別など列構成が提出先ごとに異なるため（機能設計/30_集計・出力）。

---

## 3. 生産者管理

### 3.1 `producers`（必須）
- 用途: 工場基本情報マスタ。
- 主キー: `id`。
- 主なカラム: `factory_name`, `factory_name_kana`, `bird_species_code`, `operator_type_code`, `postal_code`, `prefecture_code`, `city`, `address_line1`, `address_line2`, `region_block_code`, `status`(active/retired/merged), `retired_at`, `retired_reason`, `merged_into_producer_id`, `created_by`, `updated_by`。
- 根拠: 生産者一覧/詳細/新規登録で扱う項目（画面設計/03〜05, 機能設計/10_生産者管理各種）。

### 3.2 `producer_representatives`（任意だが推奨）
- 用途: 代表者情報（任意入力）を別テーブルで保持。
- 主なカラム: `producer_id`(FK), `name`, `title`, `phone`, `email`, `is_active`。
- 根拠: 代表者は任意かつ将来的履歴管理検討（画面設計/04,05）。

### 3.3 `producer_applicants`（必須）
- 用途: 申請者（提出窓口）情報。複数登録・履歴保持。
- 主なカラム: `producer_id`, `name`, `department`, `phone`, `email`, `is_primary`, `status`(active/inactive), `valid_from`, `valid_to`, `created_by`。
- 根拠: 申請者必須/履歴保持要件（画面設計/04,05; 機能設計/生産者詳細/新規登録）。

### 3.4 `producer_notes`（必須）
- 用途: 特記事項メモ。最新1件表示＋更新者情報。
- 主なカラム: `producer_id`, `note_text`, `updated_by_admin_id`, `updated_at`。
- 根拠: 特記事項メモ表示・他画面共有（画面設計/04, 03）。

### 3.5 `producer_histories`（必須）
- 用途: 生産者情報の変更履歴（項目差分、誰がいつ）。
- 主なカラム: `id`, `producer_id`, `performed_by_admin_id`, `action_type`, `changed_fields_json`, `created_at`。
- 根拠: 編集履歴表示要件（画面設計/04, 機能設計/04）。

### 3.6 `producer_status_logs`（推奨）
- 用途: 廃業・合併などのステータス変更イベントを保持。
- 主なカラム: `producer_id`, `status_before`, `status_after`, `reason`, `changed_by_admin_id`, `changed_at`。
- 根拠: 廃業時の理由保持・履歴（画面設計/04）。

### 3.7 `producer_merge_requests`（要件化済み）
- 用途: 合併操作の起点。申請先・ステータス管理。
- 主なカラム: `id`, `source_producer_id`, `target_producer_id`, `status`(requested/approved/applied), `memo`, `requested_by_admin_id`, `requested_at`, `resolved_at`。
- 根拠: 合併モーダル・将来ロジック（画面設計/04, 機能設計/04）。

---

## 4. データ提出（取込〜検証）

### 4.1 `input_sessions`（必須）
- 用途: CSVアップロード／手入力双方のセッションを管理。入力経路、対象月、担当職員を記録。
- 主なカラム: `id`, `producer_id`(null許容: 一括アップロード時は後で紐付け), `bird_species_code`, `target_month`, `input_method`(csv/manual), `status`(uploaded/validated/passed/aborted), `submitted_by_admin_id`, `submitted_at`, `confirmed_at`。
- 根拠: CSVアップロード〜入力確認フロー（画面設計/06〜08）。

### 4.2 `upload_files`（推奨）
- 用途: 投入されたCSVファイルのメタ情報と保存先。
- 主なカラム: `id`, `input_session_id`, `original_filename`, `storage_path`, `file_size`, `row_count`, `encoding`, `uploaded_at`。
- 根拠: CSV取込前提・原票保管リンク要件（機能設計/20_データ提出/01, 画面設計/06）。

### 4.3 `upload_rows`（推奨）
- 用途: CSV各行の正規化結果を保持。後続のバリデーション・警告CSV出力に利用。
- 主なカラム: `id`, `upload_file_id`, `row_number`, `raw_row_text`, `normalized_payload_json`, `producer_identifier`, `district_code`, `status`(ok/warn/error/skipped)。
- 根拠: 行単位の検証・エラーCSV出力（画面設計/06, 機能設計/20_データ提出/01）。

### 4.4 `upload_row_issues`（推奨）
- 用途: 行ごとのエラー/警告詳細。エラーCSV・警告CSVを再構築。
- 主なカラム: `id`, `upload_row_id`, `issue_type`, `severity`, `column_name`, `message`, `auto_fixed_flag`。
- 根拠: エラー/警告メッセージ方針（機能設計/20_データ提出/01）。

### 4.5 `submission_staging_records`（必須）
- 用途: 入力確認画面に渡す一時レコード。検証済み値とメタ情報を保持。
- 主なカラム: `id`, `input_session_id`, `producer_id`, `target_month`, `bird_species_code`, `status`(ready/fixed/rejected), `payload_hash`, `last_validated_at`。
- 根拠: 入力確認での修正・再検証（画面設計/08）。

### 4.6 `submission_staging_values`（推奨）
- 用途: `submission_metric_definitions` に基づく値ストア（decimal/int、NULLを許容）。
- 主なカラム: `staging_id`, `metric_code`, `value_decimal`, `source_column`, `is_manual_override`。
- 根拠: CSV/手入力共通での項目管理（画面設計/06〜08, 07）。

### 4.7 `submission_staging_warnings`（推奨）
- 用途: 入力確認時に表示する警告一覧。
- 主なカラム: `staging_id`, `warning_rule_code`, `severity`, `message`, `resolved_flag`, `resolved_by_admin_id`, `resolved_at`。
- 根拠: 警告確認・残ったまま登録可だが履歴を保持（画面設計/08）。

---

## 5. 提出確定・履歴

### 5.1 `submissions`（必須）
- 用途: 工場×月×鳥種の確定データ。月次提出状況や履歴の基礎。
- 主キー候補: (`producer_id`, `target_month`, `bird_species_code`, `sequence_no`) ※再提出に備えシーケンス付与。
- 主なカラム: `id`, `producer_id`, `bird_species_code`, `target_month`, `status`(registered/re-submitted/cancelled), `input_method`, `submitted_by_admin_id`, `submitted_at`, `confirmed_by_admin_id`, `confirmed_at`, `average_weight`, `comment_latest_id`, `origin_input_session_id`。
- 根拠: 提出履歴・月次状況・ダッシュボード（画面設計/02,08,09,10）。

### 5.2 `submission_values`（必須）
- 用途: 提出済データの項目値を格納。`metric_code`×`value_decimal` 形式で柔軟に対応。
- 主なカラム: `submission_id`, `metric_code`, `value_decimal`, `unit`, `source`(csv/manual), `is_nullified`。
- 根拠: 鳥種別項目差異への対応（機能設計/20_データ提出/01, 画面設計/07/08）。

### 5.3 `submission_comments`（必須）
- 用途: CSV/手入力のコメント欄・職員メモ。履歴で参照。
- 主なカラム: `id`, `submission_id`, `comment_text`, `created_by_admin_id`, `created_at`, `is_visible_on_export`。
- 根拠: コメント共有（画面設計/07,09）。

### 5.4 `submission_warnings`（必須）
- 用途: 提出確定時点の警告と対応状況。月次状況「警告あり」判定に使用。
- 主なカラム: `id`, `submission_id`, `warning_rule_code`, `severity`, `message`, `resolved_flag`, `resolved_by_admin_id`, `resolved_at`, `resolution_memo`。
- 根拠: 警告履歴表示（画面設計/09,10）。

### 5.5 `submission_versions`（必須）
- 用途: 提出履歴詳細向けのスナップショット（差分タイムライン）。
- 主なカラム: `id`, `submission_id`, `version_no`, `captured_at`, `captured_by_admin_id`, `payload_json`, `change_summary_json`。
- リレーション: `submission_version_values` を用意するか、`payload_json` に格納。
- 根拠: 修正タイムライン表示・差分ハイライト（画面設計/09）。

### 5.6 `submission_version_values`（任意）
- 用途: 版ごとの個別項目値を正規化して保持（差分比較SQLを容易にする場合）。
- 主なカラム: `submission_version_id`, `metric_code`, `value_decimal`。
- 根拠: 項目単位差分要件（画面設計/09）。

### 5.7 `submission_progress_snapshots`（推奨）
- 用途: 月次提出状況/ダッシュボード用の集計キャッシュ。月×鳥種×地域で提出済/未提出/警告件数を保持。
- 主なカラム: `target_month`, `bird_species_code`, `region_block_code`, `submitted_count`, `pending_count`, `warning_count`, `last_calculated_at`。
- 根拠: 提出状況カード、月次提出状況画面の高速化要件（画面設計/02,10）。

---

## 6. 手入力／アップロード共通ログ

### 6.1 `input_actions`（任意）
- 用途: 入力画面上の操作ログ（クリア、警告確認等）を保持し、トラブルシュートに利用。
- 主なカラム: `id`, `input_session_id`, `action_type`, `payload_json`, `performed_at`, `performed_by_admin_id`。
- 根拠: 入力確認での操作履歴参照ニーズが想定されるため（画面設計/08 からの導線ログ取得メモ）。

### 6.2 `file_storage_objects`（任意）
- 用途: オブジェクトストレージ連携メタデータ（CSV原本、警告CSV、エラーCSV等）。
- 主なカラム: `id`, `storage_path`, `category`, `related_type`, `related_id`, `expires_at`。
- 根拠: 取込結果通知で原票リンクやエラーCSVダウンロードを提供（機能設計/20_データ提出/01, 画面設計/06）。

---

## 7. レポート・エクスポート

### 7.1 `report_jobs`（推奨）
- 用途: 月次/年次レポート出力の実行履歴（条件、形式、結果ファイル）。
- 主なカラム: `id`, `job_type`(monthly/yearly/custom), `bird_species_code`, `region_block_code`, `period_start`, `period_end`, `template_code`, `output_format`, `status`, `requested_by_admin_id`, `requested_at`, `completed_at`, `file_storage_id`。
- 根拠: レポート画面のCSV/PDF出力、条件保存準備（画面設計/11）。

### 7.2 `report_job_filters`（任意）
- 用途: `report_jobs` の詳細条件（工場個別指定など）をJSON以外で保持する場合。
- 主なカラム: `report_job_id`, `filter_key`, `filter_value`。

### 7.3 `saved_report_conditions`（将来）
- 用途: ユーザー別に集計条件を保存（画面設計/11 で「将来拡張」と記載）。フェーズ1ではOFF。
- 主なカラム: `id`, `admin_id`, `condition_name`, `condition_payload_json`, `is_enabled`。

### 7.4 `export_jobs`（必須）
- 用途: 関係機関連携エクスポートの履歴と再出力機能の基盤。
- 主なカラム: `id`, `template_code`, `period_start`, `period_end`, `bird_species_code`, `region_block_code`, `producer_id`(null可), `output_format`, `status`, `requested_by_admin_id`, `requested_at`, `completed_at`, `file_storage_id`, `notes`。
- 根拠: 関係機関連携エクスポート画面（画面設計/12）。

### 7.5 `export_job_items`（任意）
- 用途: `export_jobs` が複数ファイルを生成する場合の個別トラッキング（例: 食鳥新聞地区別シート、畜産日報PDF等）。
- 主なカラム: `export_job_id`, `item_name`, `status`, `file_storage_id`, `sequence_no`。

### 7.6 `aggregation_snapshots`（推奨）
- 用途: 集計済み数値（地区別/月別/前年比）をキャッシュ。提出先別フォーマット生成時に再利用。
- 主なカラム: `id`, `bird_species_code`, `region_block_code`, `target_month`, `metric_code`, `value_decimal`, `aggregation_scope`(district/national), `source_submission_version_id`, `calculated_at`。
- 根拠: 食鳥新聞等で地区別・全国値を同時に参照、年度内累積値を保持する必要がある（機能設計/30_集計・出力/00,01）。

---

## 8. モニタリング・通知（将来拡張含む）

### 8.1 `warning_notifications`（将来）
- 用途: 未提出/警告案件の通知履歴。通知機能は検討中だがテーブル案のみ提示。
- 主なカラム: `id`, `submission_id`, `notification_type`, `channel`, `status`, `sent_at`, `remarks`。
- 根拠: 機能一覧「通知・リマインド（検討中）」。

### 8.2 `deadline_alerts`（任意）
- 用途: 締切超過の未提出リスト生成履歴。運用でCSV出力する場合に利用。
- 主なカラム: `id`, `target_month`, `bird_species_code`, `generated_by_admin_id`, `generated_at`, `file_storage_id`。
- 根拠: 月次提出状況で未提出を抽出しリマインドするフロー（画面設計/10）。

---

## 9. 補足: テーブル間の主な関連
- `producers` 1 - N `producer_applicants` / `producer_notes` / `submission_staging_records` / `submissions`。
- `input_sessions` 1 - N `upload_files` 1 - N `upload_rows` 1 - N `upload_row_issues`。
- `submission_staging_records` 1 - N `submission_staging_values` → 確定後は `submissions` / `submission_values` へ昇格。
- `submissions` 1 - N `submission_versions`・`submission_comments`・`submission_warnings`。
- `export_templates` 1 - N `export_jobs` / `report_jobs`（テンプレート共有）。
- `system_settings` は締切や閾値の初期値を提供し、UIはAPI経由で参照。

---

## 10. 次ステップメモ
1. ここで挙げたテーブルのうち、フェーズ1で確実に必要なもの（必須）と後回しにできるもの（推奨/任意/将来）を業務側と再確認する。
2. `submission_metric_definitions` の初期データ（ブロイラーCSV28列＋手入力追加項目）を整備し、`submission_values` への格納方式（decimal vs bigint＋スケール）を決定する。
3. `submission_progress_snapshots` と `aggregation_snapshots` はバッチかトリガーかを決め、再計算タイミングをダッシュボード更新頻度（5分想定）と整合させる。
4. `upload_rows` 系テーブルの保管期間・レコード数上限（最大5,000行/ファイル × ファイル数）を定義し、アーカイブ or パージ戦略を決める。
5. 合併ロジック検討時に `producer_merge_requests` と `submissions` の再紐付け手順を追加設計する。
