# 1. Docker構成まとめ（ローカル＆本番）
### ディレクトリ構成
```text
app/
├─ docker/
│  └─ app/
│      └─ Dockerfile
├─ src/                # ← Laravel本体
├─ docker-compose.local.yml
└─ docker-compose.prod.yml   # （本番用：EC2で使う想定）
```

### docker/app/Dockerfile（共通）
```dockerfile
FROM php:8.2-apache

# Laravel向け設定（DocumentRoot を public に）
RUN a2enmod rewrite
ENV APACHE_DOCUMENT_ROOT /var/www/html/public
RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' \
    /etc/apache2/sites-available/000-default.conf \
    /etc/apache2/apache2.conf

# 必要パッケージ & PHP拡張（Excel出力も意識）
RUN apt-get update && apt-get install -y \
    git \
    unzip \
    libzip-dev \
    libpng-dev \
    libonig-dev \
    libicu-dev \
    && docker-php-ext-install \
       pdo_mysql \
       zip \
       gd \
       intl \
       mbstring \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Composer
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

WORKDIR /var/www/html
```

### docker-compose.local.yml
（開発環境：EC2じゃなくローカル用）
```yaml
version: "3.9"

services:
  app:
    build:
      context: ./docker/app
    container_name: local-laravel-app
    ports:
      - "8080:80"               # http://localhost:8080
    volumes:
      - ./src:/var/www/html
    environment:
      APP_ENV: local
      APP_DEBUG: "true"
      APP_KEY: base64:xxxxxxxxxxxxxxxxxxxx==
      DB_HOST: db
      DB_DATABASE: app_db
      DB_USERNAME: app_user
      DB_PASSWORD: secret
    depends_on:
      - db

  db:
    image: mysql:8.0
    container_name: local-laravel-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: app_db
      MYSQL_USER: app_user
      MYSQL_PASSWORD: secret
    volumes:
      - db-data:/var/lib/mysql
    ports:
      - "3306:3306"

volumes:
  db-data:
```

ローカルではこれで
- app コンテナ：Laravel (php:8.2-apache)
- db コンテナ：MySQL 8.0

### docker-compose.prod.yml
（本番：EC2で使用 / DBはRDS）
```yaml
version: "3.9"

services:
  app:
    build:
      context: ./docker/app   # そのままEC2上でビルドする場合
      # もしくは ECR にpushしたイメージを使うなら：
      # image: xxxxxx.dkr.ecr.ap-northeast-1.amazonaws.com/your-app:latest
    container_name: prod-laravel-app
    ports:
      - "80:80"               # EC2の80番で公開
    volumes:
      - ./src:/var/www/html   # デプロイ方法に合わせて調整
      # Excelファイルなどが storage 配下に溜まる
      # - ./storage:/var/www/html/storage などにしてもOK
    env_file:
      - .env.prod             # DB_HOST を RDS endpoint にした .env
```

.env.prod のDB周りはこんなイメージ
```env
APP_ENV=production
APP_DEBUG=false
APP_URL=https://your-domain.example.com

DB_CONNECTION=mysql
DB_HOST=your-rds-endpoint.ap-northeast-1.rds.amazonaws.com
DB_PORT=3306
DB_DATABASE=app_db
DB_USERNAME=app_user
DB_PASSWORD=xxxxx
```

これで、
-　ローカル：docker-compose.local.yml（app+db）
-　本番EC2：docker-compose.prod.yml（appのみ、DBはRDS）

という綺麗な分離になります。

---

# 2. サーバー構成（EC2＋RDSのみ）
AWS側はこんなイメージ
```text
[ユーザーのブラウザ]
        |
   (HTTP/HTTPS)
        |
   [EC2 インスタンス]
   - Docker / docker-compose
   - app コンテナ (Laravel + Apache)
   - storage/app/exports に Excel保存
        |
   (TCP 3306)
        |
   [RDS MySQL]
   - アプリ用DB (app_db)
```

役割
- EC2
  - DockerでLaravelコンテナを1つ動かすだけ
  - docker-compose.prod.yml で app サービス起動
  - EBSに src や storage データが乗る
- RDS(MySQL)
  - 本番DB専用
  - セキュリティグループで「EC2のSGからの3306のみ許可」